blueprint:
  name: "습도 관리 & 매시간 자동 환기"
  description: >
    [v1.1 패치]
    1) 습도 상한(upper) 도달 시 연속 가동(하한 lower 이하까지)
    2) 상한 미만 상태에서는 매시 00/10/20/30/40/50분(기본 10분 슬롯)마다 1분 환기
    3) 지정 조명 중 하나라도 ON이면 환기는 즉시 중지/대기, 조명 OFF 후 조건 만족 시 재개
    4) 정기 환기 트리거는 10분 슬롯(/10)로 동작(매분 트리거로 인한 OFF 취소 문제 방지)
  domain: automation

  input:
    humidity_sensor:
      name: 습도 센서
      selector:
        entity:
          domain: sensor
          device_class: humidity

    vent_entity:
      name: 환기(팬 또는 스위치)
      selector:
        entity:
          domain:
            - fan
            - switch

    blocker_lights:
      name: 환기 대기 조건(조명들)
      description: "선택한 조명 중 하나라도 ON이면 환기를 중지/대기합니다."
      default: []
      selector:
        entity:
          domain: light
          multiple: true

    upper_humidity:
      name: 상한 임계값(%) - 이 값 이상이면 연속 가동 시작
      default: 70
      selector:
        number:
          min: 0
          max: 100
          step: 0.1
          unit_of_measurement: "%"
          mode: box

    lower_humidity:
      name: 하한 임계값(%) - 이 값 이하가 되면 연속 가동 종료
      default: 60
      selector:
        number:
          min: 0
          max: 100
          step: 0.1
          unit_of_measurement: "%"
          mode: box

    high_latch_helper:
      name: 연속 가동 상태 저장(input_boolean)
      description: "상한 도달 후 하한 이하까지 '연속 가동 상태'를 기억하는 Helper"
      selector:
        entity:
          domain: input_boolean

    periodic_enabled:
      name: 정기 환기(10분 슬롯마다 1분) 사용
      default: true
      selector:
        boolean: {}

    periodic_minutes_step:
      name: 정기 환기 슬롯 간격(분) - 10의 배수만
      description: "10/20/30/60만 권장(트리거는 10분 슬롯에서만 발생하고 내부에서 step을 추가로 필터링)"
      default: 10
      selector:
        number:
          min: 10
          max: 60
          step: 10
          unit_of_measurement: "min"
          mode: box

    periodic_run_seconds:
      name: 정기 환기 가동 시간(초) - 기본 60초(1분)
      default: 60
      selector:
        number:
          min: 10
          max: 600
          step: 5
          unit_of_measurement: "s"
          mode: slider

    protect_manual_on:
      name: 수동 ON 보호(정기 환기만)
      description: "정기 환기 시작 시 이미 환기가 켜져있었다면, 1분 후 끄지 않습니다."
      default: true
      selector:
        boolean: {}

    debug_log:
      name: 로그북 기록(디버그)
      default: false
      selector:
        boolean: {}

mode: restart
max_exceeded: silent

variables:
  humidity_sensor: !input humidity_sensor
  vent_entity: !input vent_entity
  blocker_lights: !input blocker_lights
  upper: !input upper_humidity
  lower: !input lower_humidity
  latch: !input high_latch_helper
  periodic_enabled: !input periodic_enabled
  periodic_step: !input periodic_minutes_step
  periodic_seconds: !input periodic_run_seconds
  protect_manual_on: !input protect_manual_on
  debug_log: !input debug_log

  blockers_any_on: >-
    {{ expand(blocker_lights) | selectattr('state','eq','on') | list | length > 0 }}
  h: >-
    {{ states(humidity_sensor) | float(0) }}

trigger:
  - platform: numeric_state
    entity_id: !input humidity_sensor
    above: !input upper_humidity
    id: humidity_high

  - platform: numeric_state
    entity_id: !input humidity_sensor
    below: !input lower_humidity
    id: humidity_low

  - platform: state
    entity_id: !input blocker_lights
    to: "on"
    id: light_on

  - platform: state
    entity_id: !input blocker_lights
    to: "off"
    id: light_off

  # ✅ 10분 슬롯에서만 트리거(00/10/20/30/40/50)
  - platform: time_pattern
    minutes: "/10"
    seconds: 0
    id: periodic_tick

  - platform: homeassistant
    event: start
    id: ha_start

action:
  - choose:
      # 1) 상한 도달: 래치 ON, (조명 OFF일 때) 환기 ON
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'humidity_high' }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: !input high_latch_helper
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not blockers_any_on }}"
                sequence:
                  - service: homeassistant.turn_on
                    target:
                      entity_id: !input vent_entity
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug_log }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "습도관리/자동환기"
                      message: "상한 도달(h={{ states(humidity_sensor) }}%) → 연속가동 래치 ON, 조명ON={{ blockers_any_on }}"
                      entity_id: !input vent_entity

      # 2) 하한 이하: 래치 OFF, 환기 OFF
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'humidity_low' }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: !input high_latch_helper
          - service: homeassistant.turn_off
            target:
              entity_id: !input vent_entity
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug_log }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "습도관리/자동환기"
                      message: "하한 이하(h={{ states(humidity_sensor) }}%) → 연속가동 래치 OFF, 환기 OFF"
                      entity_id: !input vent_entity

      # 3) 조명 ON: 환기 즉시 OFF(대기)
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'light_on' }}"
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: !input vent_entity
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ debug_log }}"
                sequence:
                  - service: logbook.log
                    data:
                      name: "습도관리/자동환기"
                      message: "조명 ON 감지 → 환기 OFF(대기)"
                      entity_id: !input vent_entity

      # 4) 조명 OFF 또는 HA 시작: 상태 동기화 + (조명 OFF & 연속가동 필요하면) 환기 ON
      - conditions:
          - condition: template
            value_template: "{{ trigger.id in ['light_off','ha_start'] }}"
        sequence:
          # 현재 습도로 래치 보정(재시작/예외 대비)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (states(humidity_sensor) | float(0)) >= (upper | float) }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input high_latch_helper
              - conditions:
                  - condition: template
                    value_template: "{{ (states(humidity_sensor) | float(0)) <= (lower | float) }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: !input high_latch_helper

          # 조명이 모두 OFF이고, 래치가 ON이면 환기 ON
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not blockers_any_on }}"
                  - condition: state
                    entity_id: !input high_latch_helper
                    state: "on"
                  - condition: template
                    value_template: "{{ (states(humidity_sensor) | float(0)) > (lower | float) }}"
                sequence:
                  - service: homeassistant.turn_on
                    target:
                      entity_id: !input vent_entity

      # 5) 정기 환기 tick(10분 슬롯에서만 트리거됨): 연속가동 아님 + 조명 OFF + step 조건 만족 → 1분 ON
      - conditions:
          - condition: template
            value_template: "{{ trigger.id == 'periodic_tick' }}"
        sequence:
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ not periodic_enabled }}"
                sequence:
                  - stop: "정기 환기 비활성"

          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ blockers_any_on }}"
                sequence:
                  - stop: "조명 ON → 정기 환기 대기(슬롯 스킵)"

          # 혹시 현재 습도가 상한 이상이면 연속가동으로 전환(누락 대비)
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (states(humidity_sensor) | float(0)) >= (upper | float) }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: !input high_latch_helper
                  - service: homeassistant.turn_on
                    target:
                      entity_id: !input vent_entity
                  - stop: "현재 습도 상한 이상 → 연속가동 우선"

          - choose:
              - conditions:
                  - condition: state
                    entity_id: !input high_latch_helper
                    state: "on"
                sequence:
                  - stop: "연속가동 중 → 정기 환기 무시"

          # step이 20/30/60인 경우를 위한 추가 필터
          - condition: template
            value_template: "{{ (now().minute % (periodic_step | int(10))) == 0 }}"

          - variables:
              was_on: "{{ is_state(vent_entity, 'on') }}"

          - service: homeassistant.turn_on
            target:
              entity_id: !input vent_entity

          - delay:
              seconds: !input periodic_run_seconds

          # 1분 후 OFF: (수동 ON 보호 옵션) & 그 사이 연속가동/조명ON/상한도달이 아니어야 함
          - choose:
              - conditions:
                  - condition: template
                    value_template: "{{ (not protect_manual_on) or (not was_on) }}"
                  - condition: template
                    value_template: "{{ not (expand(blocker_lights) | selectattr('state','eq','on') | list | length > 0) }}"
                  - condition: state
                    entity_id: !input high_latch_helper
                    state: "off"
                  - condition: template
                    value_template: "{{ (states(humidity_sensor) | float(0)) < (upper | float) }}"
                sequence:
                  - service: homeassistant.turn_off
                    target:
                      entity_id: !input vent_entity
